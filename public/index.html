<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>{{SITE_NAME}}</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 1rem;
  }
  h1 a {
    text-decoration: none;
    color: #333;
  }
  #upload-area {
    border: 2px dashed #aaa;
    padding: 20px;
    text-align: center;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #upload-area.dragover {
    background-color: #def;
  }
  #upload-input {
    display: none;
  }
  #gallery {
    margin-top: 2rem;
  }
  .image-item {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
  }
  .image-item img {
    max-width: 250px;
    max-height: 250px;
    margin-right: 10px;
    object-fit: contain;
    border: 1px solid #ccc;
  }
  .image-url {
    flex-grow: 1;
    margin-right: 10px;
  }
  .image-url input {
    width: 100%;
    padding: 5px;
    font-size: 0.9rem;
  }
  button.copy-btn {
    background-color: #007bff;
    border: none;
    color: white;
    padding: 6px 10px;
    cursor: pointer;
    margin-right: 5px;
    text-transform: uppercase;
    font-weight: bold;
  }
  button.delete-btn {
    background-color: #dc3545;
    border: none;
    color: white;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
  }
</style>
</head>
<body>

<h1><a href="/">{{SITE_NAME}}</a></h1>

<div id="upload-area">
  <p>Drag & drop an image here or click to select</p>
  <input type="file" id="upload-input" accept="image/*" />
</div>

<div id="gallery"></div>

<script>
  const uploadArea = document.getElementById('upload-area');
  const uploadInput = document.getElementById('upload-input');
  const gallery = document.getElementById('gallery');

  let cookieName = 'screenDawgImages'; // default values, will be overridden
  let cookieMaxAgeDays = 0;

  // Fetch config from backend to get cookie info
  fetch('/config')
    .then(res => res.json())
    .then(cfg => {
      cookieName = cfg.cookie_name || cookieName;
      cookieMaxAgeDays = typeof cfg.cookie_max_age_days === 'number' ? cfg.cookie_max_age_days : cookieMaxAgeDays;
      renderGallery();
    })
    .catch(() => {
      renderGallery();
    });

  // Load user images from cookie
  function getUserImages() {
    const cookieData = document.cookie.split('; ').find(row => row.startsWith(cookieName + '='));
    if (!cookieData) return [];
    try {
      return JSON.parse(decodeURIComponent(cookieData.split('=')[1])) || [];
    } catch {
      return [];
    }
  }

  // Save user images to cookie
  function saveUserImages(images) {
    let cookieStr = `${cookieName}=${encodeURIComponent(JSON.stringify(images))};path=/;`;
    if (cookieMaxAgeDays === 0) {
      cookieStr += 'expires=Fri, 31 Dec 9999 23:59:59 GMT;';
    } else {
      const maxAgeSeconds = cookieMaxAgeDays * 24 * 60 * 60;
      cookieStr += `max-age=${maxAgeSeconds};`;
    }
    document.cookie = cookieStr;
  }

  // Copy text to clipboard helper
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Copied!');
    }).catch(() => {
      alert('Failed to copy.');
    });
  }

  // Render gallery images
  function renderGallery() {
    const images = getUserImages();
    gallery.innerHTML = '';

    if (images.length === 0) {
      gallery.innerHTML = '<p>No images uploaded yet.</p>';
      return;
    }

    images.forEach(url => {
      const container = document.createElement('div');
      container.className = 'image-item';

      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Uploaded image';

      const urlDiv = document.createElement('div');
      urlDiv.className = 'image-url';

      const input = document.createElement('input');
      input.type = 'text';
      input.readOnly = true;
      input.value = window.location.origin + url;
      urlDiv.appendChild(input);

      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'COPY';
      copyBtn.className = 'copy-btn';
      copyBtn.onclick = () => copyToClipboard(input.value);

      const deleteBtn = document.createElement('button');
      deleteBtn.innerHTML = 'ðŸ—‘ï¸';
      deleteBtn.className = 'delete-btn';
      deleteBtn.onclick = () => {
        if (!confirm('Are you sure you want to delete this image?')) return;
        fetch('/delete-image', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url }),
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Remove from cookie list
            const updatedImages = getUserImages().filter(i => i !== url);
            saveUserImages(updatedImages);
            renderGallery();
          } else {
            alert('Error deleting image: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(() => alert('Error deleting image'));
      };

      container.appendChild(img);
      container.appendChild(urlDiv);
      container.appendChild(copyBtn);
      container.appendChild(deleteBtn);

      gallery.appendChild(container);
    });
  }

  // Handle file upload
  function uploadFile(file) {
    const formData = new FormData();
    formData.append('image', file);

    fetch('/upload', {
      method: 'POST',
      body: formData,
    })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.url) {
        const images = getUserImages();
        images.unshift(data.url); // Add newest first
        saveUserImages(images);
        renderGallery();
      } else {
        alert('Upload failed: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(() => alert('Upload failed'));
  }

  // Drag & drop handlers
  uploadArea.addEventListener('click', () => uploadInput.click());

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      const file = e.dataTransfer.files[0];
      if (!file.type.startsWith('image/')) {
        alert('Please upload only image files.');
        return;
      }
      uploadFile(file);
    }
  });

  // Auto-upload on file select
  uploadInput.addEventListener('change', () => {
    if (uploadInput.files.length) {
      const file = uploadInput.files[0];
      if (!file.type.startsWith('image/')) {
        alert('Please upload only image files.');
        return;
      }
      uploadFile(file);
      uploadInput.value = ''; // reset input
    }
  });
</script>

</body>
</html>
