<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üñºÔ∏èüê∂ ScreenDawg</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }

    .upload-box {
      border: 2px dashed #aaa;
      border-radius: 10px;
      background: white;
      text-align: center;
      padding: 40px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .upload-box.dragover {
      border-color: #007bff;
      background: #e6f0ff;
    }

    .gallery-item {
      display: flex;
      align-items: center;
      margin-top: 10px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .gallery-item img {
      max-width: 250px;
      max-height: 250px;
      margin-right: 10px;
      border-radius: 5px;
    }

    .gallery-info {
      flex-grow: 1;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    input[type="text"] {
      flex-grow: 1;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .copy-btn,
    .delete-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .copy-btn {
      background: #007bff;
      color: white;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <h1>üñºÔ∏èüê∂ ScreenDawg</h1>

  <div id="uploadBox" class="upload-box">
    Click or drag & drop an image here to upload
    <input type="file" id="imageInput" name="image" accept="image/*" style="display:none" />
  </div>

  <div id="preview"></div>
  <hr />
  <h2>Your Uploaded Images</h2>
  <div id="history"></div>

  <script>
    const uploadBox = document.getElementById("uploadBox");
    const imageInput = document.getElementById("imageInput");
    const preview = document.getElementById("preview");
    const history = document.getElementById("history");

    uploadBox.addEventListener("click", () => imageInput.click());

    uploadBox.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadBox.classList.add("dragover");
    });

    uploadBox.addEventListener("dragleave", () => {
      uploadBox.classList.remove("dragover");
    });

    uploadBox.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadBox.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) uploadImage(file);
    });

    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (file) uploadImage(file);
    });

    function uploadImage(file) {
      const formData = new FormData();
      formData.append("image", file);
      fetch("/upload", {
        method: "POST",
        body: formData,
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            const url = data.url;
            const img = document.createElement("img");
            img.src = url;
            preview.innerHTML = "";
            preview.appendChild(img);

            const urls = getHistory();
            urls.push(url);
            setHistory(urls);
            renderHistory();
          } else {
            alert(data.error || "Upload failed");
          }
        })
        .catch(() => alert("Upload error"));
    }

    function getHistory() {
      const cookie = document.cookie
        .split("; ")
        .find((row) => row.startsWith("images="));
      if (!cookie) return [];
      try {
        return JSON.parse(decodeURIComponent(cookie.split("=")[1]));
      } catch {
        return [];
      }
    }

    function setHistory(arr) {
      document.cookie =
        "images=" +
        encodeURIComponent(JSON.stringify(arr)) +
        "; path=/; max-age=31536000";
    }

    function renderHistory() {
      const urls = getHistory();
      history.innerHTML = "";
      const validUrls = [];

      urls.forEach((url) => {
        fetch(url, { method: "HEAD" })
          .then((response) => {
            if (response.ok) {
              validUrls.push(url);

              const div = document.createElement("div");
              div.className = "gallery-item";

              const img = document.createElement("img");
              img.src = url;

              const info = document.createElement("div");
              info.className = "gallery-info";

              const input = document.createElement("input");
              input.type = "text";
              input.value = window.location.origin + url;
              input.readOnly = true;

              const copyBtn = document.createElement("button");
              copyBtn.textContent = "COPY";
              copyBtn.className = "copy-btn";
              copyBtn.onclick = () => {
                input.select();
                document.execCommand("copy");
              };

              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "üóëÔ∏è";
              deleteBtn.className = "delete-btn";
              deleteBtn.onclick = () => {
                if (
                  confirm("Are you sure you want to delete this image?")
                ) {
                  fetch("/delete-image", {
                    method: "DELETE",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ url }),
                  })
                    .then((res) => res.json())
                    .then((data) => {
                      if (data.success) {
                        const filtered = getHistory().filter(
                          (item) => item !== url
                        );
                        setHistory(filtered);
                        renderHistory();
                      } else {
                        alert(
                          "Error deleting image: " +
                            (data.error || "Unknown error")
                        );
                      }
                    })
                    .catch(() =>
                      alert("Server error while deleting image.")
                    );
                }
              };

              info.append(input, copyBtn, deleteBtn);
              div.append(img, info);
              history.appendChild(div);
            } else {
              const filtered = getHistory().filter((item) => item !== url);
              setHistory(filtered);
            }
          })
          .catch(() => {
            const filtered = getHistory().filter((item) => item !== url);
            setHistory(filtered);
          });
      });
    }

    renderHistory();
  </script>
</body>
</html>
